<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu√† t·∫∑ng ƒë·∫∑c bi·ªát d√†nh cho ch·ªã Th√∫y Min</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        video { transform: scaleX(-1); object-fit: cover; }
        /* Hi·ªáu ·ª©ng rung khi c∆∞·ªùi to */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="main-card" class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm text-center border-4 border-pink-200">
        <h1 class="text-xl font-bold text-pink-600 mb-2">üéÅ QU√Ä T·∫∂NG CH·ªä TH√öY MIN</h1>
        <p class="text-sm text-gray-500 mb-4">Nhi·ªám v·ª•: C∆∞·ªùi nhe rƒÉng & C∆∞·ªùi th√†nh ti·∫øng!</p>
        
        <div id="container" class="relative rounded-2xl overflow-hidden bg-black aspect-square mb-4 shadow-inner border-2 border-gray-200">
            <video id="video" class="w-full h-full" autoplay muted playsinline webkit-playsinline></video>
            
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 flex justify-around">
                <span id="debug-smile">üòê M·∫∑t l·∫°nh</span>
                <span id="debug-mouth">ü§ê M√≠m m√¥i</span>
                <span id="debug-sound">üîá Im l·∫∑ng</span>
            </div>

            <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-90 text-white p-4 z-10">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-pink-500 mb-3"></div>
                <p id="loader-text" class="text-center text-sm animate-pulse">ƒêang t·∫£i tr√≠ tu·ªá nh√¢n t·∫°o...</p>
            </div>
        </div>

        <div id="status" class="text-lg font-bold text-gray-700 mb-2 h-16 flex items-center justify-center">
            ƒêang kh·ªüi ƒë·ªông...
        </div>
        
        <div class="relative w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
            <div id="progress" class="bg-gradient-to-r from-pink-400 to-red-500 h-4 rounded-full transition-all duration-200" style="width: 0%"></div>
            <p class="absolute inset-0 text-[10px] flex items-center justify-center text-white font-bold drop-shadow">M·ª®C ƒê·ªò VUI V·∫∫</p>
        </div>
        
        <button id="btn-start" class="hidden w-full py-3 bg-pink-500 text-white rounded-xl font-bold hover:bg-pink-600 shadow-lg transition transform active:scale-95" onclick="startApp()">
            B·∫ÆT ƒê·∫¶U TH√îI üì∏
        </button>
    </div>

    <script>
        const video = document.getElementById('video');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress');
        const btnStart = document.getElementById('btn-start');
        const mainCard = document.getElementById('main-card');

        // Debug elements
        const dSmile = document.getElementById('debug-smile');
        const dMouth = document.getElementById('debug-mouth');
        const dSound = document.getElementById('debug-sound');

        // C·∫§U H√åNH LI√äN K·∫æT V√Ä ƒê·ªò KH√ì
        const VOUCHER_LINK = "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWYxbWJnbzA4MG4xdzZ1aTl5ajkwZzRzcmE2a3cxamNxZWl2cXhxaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/gNke2UrUTopOg/giphy.gif"; 
        const THRESHOLD_SMILE = 0.8;      // ƒê·ªô c∆∞·ªùi (0-1)
        const THRESHOLD_MOUTH_OPEN = 0.05; // T·ª∑ l·ªá m·ªü mi·ªáng (cao/r·ªông)
        const THRESHOLD_VOLUME = 15;      // ƒê·ªô l·ªõn √¢m thanh (0-100)

        let audioContext;
        let analyser;
        let microphone;
        let isSuccess = false;

        // 1. T·∫£i Models
        async function loadModels() {
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL), // C·∫ßn c√°i n√†y ƒë·ªÉ check m·ªü mi·ªáng
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                loaderText.innerText = "ƒê√£ t·∫£i xong! Nh·∫•n n√∫t b√™n d∆∞·ªõi nh√© üëá";
                document.querySelector('.animate-spin').style.display = 'none';
                btnStart.classList.remove('hidden');
            } catch (err) {
                loaderText.innerText = "L·ªói t·∫£i model: " + err;
            }
        }

        // 2. Kh·ªüi ƒë·ªông Camera & Micro
        async function startApp() {
            btnStart.classList.add('hidden');
            loaderText.innerText = "ƒêang xin quy·ªÅn Camera & Micro...";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" },
                    audio: true 
                });
                
                video.srcObject = stream;
                setupAudioAnalysis(stream);

                video.addEventListener('loadedmetadata', () => {
                    video.play();
                    loader.style.display = 'none';
                    detectFrame();
                });
            } catch (err) {
                alert("L·ªói: B·∫°n c·∫ßn cho ph√©p quy·ªÅn Camera v√† Micro ƒë·ªÉ ch∆°i!");
                console.error(err);
            }
        }

        // 3. Thi·∫øt l·∫≠p ph√¢n t√≠ch √¢m thanh
        function setupAudioAnalysis(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
        }

        function getVolume() {
            if (!analyser) return 0;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            // L·∫•y trung b√¨nh c·ªông bi√™n ƒë·ªô c√°c t·∫ßn s·ªë
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            return sum / dataArray.length;
        }

        // 4. V√≤ng l·∫∑p ph√°t hi·ªán
        async function detectFrame() {
            if (isSuccess) return;

            // Detect m·∫∑t + ƒëi·ªÉm neo (landmarks) + bi·ªÉu c·∫£m
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions();

            let smileScore = 0;
            let isMouthOpen = false;
            let currentVol = getVolume();

            if (detection) {
                // a. Check C∆∞·ªùi
                smileScore = detection.expressions.happy;

                // b. Check M·ªü mi·ªáng (Nhe rƒÉng)
                // L·∫•y ƒëi·ªÉm m√¥i tr√™n (62) v√† m√¥i d∆∞·ªõi (66)
                const mouth = detection.landmarks.getMouth();
                const upperLipBottom = mouth[14]; // ƒëi·ªÉm gi·ªØa m√¥i tr√™n trong
                const lowerLipTop = mouth[18];    // ƒëi·ªÉm gi·ªØa m√¥i d∆∞·ªõi trong
                
                // T√≠nh kho·∫£ng c√°ch
                const mouthOpening = Math.abs(upperLipBottom.y - lowerLipTop.y);
                const faceHeight = detection.detection.box.height;
                
                // T·ª∑ l·ªá m·ªü mi·ªáng so v·ªõi khu√¥n m·∫∑t
                const ratio = mouthOpening / faceHeight;
                isMouthOpen = ratio > THRESHOLD_MOUTH_OPEN;

                // C·∫≠p nh·∫≠t UI Debug
                dSmile.innerText = smileScore > THRESHOLD_SMILE ? "üòÜ T∆∞∆°i" : "üòê Ch∆∞a t∆∞∆°i";
                dMouth.innerText = isMouthOpen ? "üò¨ Nhe rƒÉng" : "ü§ê M√≠m m√¥i";
            }

            // C·∫≠p nh·∫≠t UI Sound Debug
            dSound.innerText = currentVol > THRESHOLD_VOLUME ? "üîä ·ªín √†o" : "üîá Im l·∫∑ng";

            // X·ª≠ l√Ω Logic Game
            updateGameStatus(smileScore, isMouthOpen, currentVol);

            // L·∫∑p l·∫°i nhanh nh·∫•t c√≥ th·ªÉ
            requestAnimationFrame(detectFrame);
        }

        function updateGameStatus(smile, mouthOpen, vol) {
            let totalScore = 0;
            let message = "";
            let color = "bg-red-500";

            // Logic t√≠nh ƒëi·ªÉm v√† h∆∞·ªõng d·∫´n
            if (smile < THRESHOLD_SMILE) {
                message = "Ch·ªã Min c∆∞·ªùi t∆∞∆°i l√™n n√†o! üòÅ";
                totalScore = smile * 50;
            } else if (!mouthOpen) {
                message = "C∆∞·ªùi nhe rƒÉng ra ch·ªã ∆°i! üò¨";
                totalScore = 70;
            } else if (vol < THRESHOLD_VOLUME) {
                message = "Ph·∫£i c∆∞·ªùi th√†nh ti·∫øng c∆°! Ha ha ha! üîä";
                totalScore = 85;
                mainCard.classList.remove('shake');
            } else {
                // TH√ÄNH C√îNG
                message = "TUY·ªÜT V·ªúI !!! üéâ";
                totalScore = 100;
                color = "bg-green-500";
                mainCard.classList.add('shake');
                
                if (!isSuccess) {
                    isSuccess = true;
                    status.innerText = message;
                    status.className = "text-xl font-bold text-green-600 mb-2 animate-bounce";
                    progress.style.width = "100%";
                    progress.className = "bg-green-500 h-4 rounded-full";
                    
                    setTimeout(() => {
                        alert("Ch√∫c m·ª´ng ch·ªã Th√∫y Min! ƒêang chuy·ªÉn ƒë·∫øn qu√†...");
                        window.location.href = VOUCHER_LINK;
                    }, 1000);
                    return;
                }
            }

            status.innerText = message;
            progress.style.width = totalScore + "%";
        }

        // B·∫Øt ƒë·∫ßu t·∫£i model ngay khi v√†o web
        loadModels();

    </script>
</body>
</html>
