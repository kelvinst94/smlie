<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Qu√† t·∫∑ng ƒë·∫∑c bi·ªát cho ch·ªã Th√∫y Min üéÅ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        video { transform: scaleX(-1); object-fit: cover; }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .rainbow-bar {
            background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            background-size: 200% 200%;
            animation: rainbow 2s ease infinite;
        }
        @keyframes rainbow { 
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .progress-glow {
            box-shadow: 0 0 20px #ec4899, 0 0 40px #ec4899;
            animation: pulse-glow 1s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px #ec4899; }
            50% { box-shadow: 0 0 30px #ec4899, 0 0 50px #ec4899; }
        }

        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-200px) scale(1.5); opacity: 0; }
        }
        .floating-emoji {
            position: fixed;
            animation: float-up 2s ease-out forwards;
            font-size: 2rem;
            z-index: 100;
            pointer-events: none;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .sparkle {
            animation: sparkle 0.6s ease-in-out infinite;
        }

        .combo-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 50;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .combo-display.show {
            transform: scale(1);
        }

        .tutorial-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .tutorial-content {
            background: white;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 10px;
        }

        .step-1 .step-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .step-2 .step-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .step-3 .step-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 640px) {
            body { padding: 8px; }
            #main-card { padding: 16px; max-width: 100%; border-width: 2px; }
            #main-card h1 { font-size: 1.25rem; letter-spacing: -0.025em; }
            #main-card p { font-size: 0.75rem; }
            .relative.rounded-2xl { aspect-ratio: 3/4; max-height: 60vh; }
            .absolute.top-2 { font-size: 9px; padding: 6px; top: 8px; left: 8px; right: 8px; }
            .absolute.top-2 span { font-size: 10px; }
            .absolute.top-2 .text-gray-400 { font-size: 8px; }
            #game-msg { font-size: 0.875rem; padding: 0 4px; line-height: 1.3; }
            .w-full.bg-gray-100 { height: 12px; margin-bottom: 16px; }
            #btn-start { padding: 12px; font-size: 0.875rem; }
            .combo-display { top: 10px; right: 10px; padding: 8px 16px; font-size: 0.875rem; }
            .tutorial-content { max-width: 95%; margin: 0 10px; }
            .tutorial-content h2 { font-size: 1.5rem; }
            .tutorial-content .text-5xl { font-size: 3rem; }
            .step-icon { width: 48px; height: 48px; font-size: 1.5rem; }
            .tutorial-content .p-6 { padding: 16px; }
            .tutorial-content .space-y-4 > div { padding: 12px; }
            .tutorial-content h3 { font-size: 0.875rem; }
            .tutorial-content .text-sm { font-size: 0.75rem; }
            .tutorial-content button { padding: 14px; font-size: 0.875rem; }
            .floating-emoji { font-size: 1.5rem; }
            #error-msg { font-size: 0.75rem; }
            #error-area button { font-size: 0.75rem; padding: 8px 16px; }
        }

        @media (max-width: 375px) {
            #main-card h1 { font-size: 1.125rem; }
            #game-msg { font-size: 0.8rem; }
            .step-icon { width: 40px; height: 40px; font-size: 1.25rem; }
        }

        @media (max-height: 600px) and (orientation: landscape) {
            body { justify-content: flex-start; padding-top: 10px; }
            #main-card { max-width: 90%; }
            .relative.rounded-2xl { max-height: 70vh; }
            .tutorial-modal { overflow-y: auto; }
            .tutorial-content { margin: 20px auto; }
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen flex flex-col items-center justify-center p-4 font-sans select-none">

    <div id="tutorial-modal" class="tutorial-modal">
        <div class="tutorial-content">
            <div class="bg-gradient-to-r from-pink-500 to-purple-600 p-6 text-white text-center">
                <div class="text-5xl mb-3 float-animation">üéÅ</div>
                <h2 class="text-2xl font-black uppercase">H∆∞·ªõng d·∫´n ch∆°i</h2>
                <p class="text-sm opacity-90 mt-2">Ch·ªã Min l√†m theo 3 b∆∞·ªõc ƒë·ªÉ nh·∫≠n qu√† nh√©!</p>
            </div>

            <div class="p-6 space-y-4">
                <div class="step-1 bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                    <div class="step-icon">üòä</div>
                    <h3 class="font-bold text-center text-purple-900 mb-2">B∆∞·ªõc 1: C∆∞·ªùi T∆∞∆°i</h3>
                    <p class="text-sm text-center text-gray-600">
                        C∆∞·ªùi th·∫≠t r·ªông v√† t∆∞∆°i t·∫Øn nh·∫•t c√≥ th·ªÉ!
                        <br><span class="font-semibold text-purple-700">ƒê·∫°t 80% ƒë·ªô vui</span>
                    </p>
                </div>

                <div class="step-2 bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                    <div class="step-icon">üò¨</div>
                    <h3 class="font-bold text-center text-pink-900 mb-2">B∆∞·ªõc 2: H√° Mi·ªáng</h3>
                    <p class="text-sm text-center text-gray-600">
                        Nhe rƒÉng ra!
                        <br><span class="font-semibold text-pink-700">Ph·∫£i th·∫•y rƒÉng r√µ r√†ng</span>
                    </p>
                </div>

                <div class="step-3 bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                    <div class="step-icon">üîä</div>
                    <h3 class="font-bold text-center text-blue-900 mb-2">B∆∞·ªõc 3: C∆∞·ªùi To</h3>
                    <p class="text-sm text-center text-gray-600">
                        C∆∞·ªùi th√†nh ti·∫øng: "HA HA HA! v√† n√≥i T√¥i r·∫•t vui v·ªõi m√≥n qu√† c·ªßa Th·ªçi"
                        <br><span class="font-semibold text-blue-700">Cho mic nghe r√µ</span>
                    </p>
                </div>

                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-3 mt-4">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                        <div class="text-xs text-gray-700">
                            <span class="font-bold text-yellow-800">L∆∞u √Ω quan tr·ªçng:</span>
                            Ph·∫£i cho ph√©p Camera v√† Microphone khi tr√¨nh duy·ªát h·ªèi!
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 pt-0">
                <button onclick="closeTutorial()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl active:scale-95 transition-all">
                    <i class="fas fa-play-circle mr-2"></i> B·∫Øt ƒë·∫ßu ngay! üöÄ
                </button>
            </div>
        </div>
    </div>

    <div id="combo-counter" class="combo-display">
        <i class="fas fa-fire"></i> <span id="combo-num">0</span>x COMBO!
    </div>

    <div id="main-card" class="bg-white p-5 rounded-3xl shadow-2xl w-full max-w-sm text-center border-4 border-white relative transition-all duration-300">

        <div class="mb-4">
            <h1 class="text-2xl font-black text-pink-600 uppercase tracking-tighter">NHI·ªÜM V·ª§ NH·∫¨N QU√Ä</h1>
            <p class="text-sm text-gray-500">Ch·ªã Min h√£y c∆∞·ªùi th·∫≠t vui s∆∞·ªõng ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c qu√† nh√° üéÅ</p>
        </div>

        <div class="relative rounded-2xl overflow-hidden bg-black aspect-[3/4] mb-4 shadow-inner ring-4 ring-pink-100">
            <video id="video" class="w-full h-full" autoplay muted playsinline webkit-playsinline></video>

            <div class="absolute top-2 left-2 right-2 flex justify-between text-[10px] font-mono text-white bg-black/50 p-2 rounded backdrop-blur-sm z-10">
                <div class="flex flex-col items-center">
                    <span id="txt-smile">üòê 0%</span>
                    <span class="text-gray-400">ƒê·ªò T∆Ø∆†I</span>
                </div>
                <div class="flex flex-col items-center border-x border-gray-600 px-2">
                    <span id="txt-mouth">ü§ê ƒê√≥ng</span>
                    <span class="text-gray-400">MI·ªÜNG</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="txt-vol">üîá 0</span>
                    <span class="text-gray-400">√ÇM L∆Ø·ª¢NG</span>
                </div>
            </div>

            <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-zinc-900 text-white z-20 transition-opacity duration-500">
                <div id="spinner" class="animate-spin rounded-full h-10 w-10 border-4 border-pink-500 border-t-transparent mb-4"></div>
                <p id="status-text" class="text-sm font-medium animate-pulse">ƒêang k·∫øt n·ªëi AI...</p>

                <div id="error-area" class="hidden flex flex-col items-center mt-4 w-3/4">
                    <p id="error-msg" class="text-xs text-red-400 text-center mb-3 border border-red-500/50 p-2 rounded bg-red-900/20">L·ªói kh√¥ng x√°c ƒë·ªãnh</p>
                    <button onclick="window.location.href = VOUCHER_LINK" class="bg-white text-black px-4 py-2 rounded-full text-xs font-bold hover:bg-gray-200">
                        üéÅ B·ªè qua & Nh·∫≠n qu√† lu√¥n
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-2 h-8 flex items-center justify-center">
            <span id="game-msg" class="text-lg font-bold text-gray-700">ƒêang chu·∫©n b·ªã...</span>
        </div>

        <div class="w-full bg-gray-100 rounded-full h-4 mb-5 overflow-hidden ring-1 ring-gray-200">
            <div id="progress-bar" class="bg-pink-500 h-full w-0 transition-all duration-300 ease-out"></div>
        </div>

        <button id="btn-start" class="hidden w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-bold shadow-lg shadow-pink-500/30 active:scale-95 transition-transform" onclick="initApp()">
            <i class="fas fa-camera mr-2"></i> Z√¥ lu√¥n
        </button>
    </div>

    <script>
        const VOUCHER_LINK = "https://cdn.pixabay.com/animation/2024/10/16/09/27/09-27-15-148_512.gif"; 

        const THRESHOLD = {
            smile: 0.8,
            mouth: 0.15,
            volume: 50
        };

        const MESSAGES = {
            needSmile: [
                "C∆∞·ªùi l√™n n√†o ch·ªã Min ∆°i! üòÑ",
                "T·∫øt ƒë·∫øn r·ªìi, c∆∞·ªùi ƒëi ch·ªã! üéä",
                "N·ª• c∆∞·ªùi ƒë√¢u r·ªìi? üòÅ",
                "C∆∞·ªùi th·∫≠t t∆∞∆°i cho anh xem n√†o! ‚ú®",
                "H√£y c∆∞·ªùi nh∆∞ ƒë∆∞·ª£c tr√∫ng x·ªï s·ªë! üé∞"
            ],
            needMouth: [
                "H√° mi·ªáng ra, ƒë·ª´ng ng·∫°i! üò¨",
                "Nhe rƒÉng ƒëi ch·ªã, anh kh√¥ng c·∫Øn ƒë√¢u! üòÜ",
                "C∆∞·ªùi toe to√©t l√™n n√†o! ü¶∑",
                "RƒÉng ƒë·∫πp v·∫≠y m√† kh√¥ng khoe √†! üòÅ",
                "M·ªü mi·ªáng ra nh∆∞ ƒëang h√°t Karaoke! üé§"
            ],
            needVolume: [
                "C∆∞·ªùi th√†nh ti·∫øng ƒëi: HA HA HA! üîä",
                "To h∆°n n·ªØa! Kh√¥ng ai c·∫•m m√†! üì¢",
                "Ti·∫øng c∆∞·ªùi ƒë√¢u r·ªìi? üé§",
                "C∆∞·ªùi tho·∫£i m√°i ƒëi ch·ªã ∆°i! üòÇ",
                "Nh∆∞ v·∫≠y m·ªõi vui ch·ª©! C∆∞·ªùi to l√™n! üé∫"
            ]
        };

        const UI = {
            video: document.getElementById('video'),
            overlay: document.getElementById('overlay'),
            spinner: document.getElementById('spinner'),
            statusText: document.getElementById('status-text'),
            errorArea: document.getElementById('error-area'),
            errorMsg: document.getElementById('error-msg'),
            btnStart: document.getElementById('btn-start'),
            gameMsg: document.getElementById('game-msg'),
            progressBar: document.getElementById('progress-bar'),
            txtSmile: document.getElementById('txt-smile'),
            txtMouth: document.getElementById('txt-mouth'),
            txtVol: document.getElementById('txt-vol'),
            card: document.getElementById('main-card'),
            comboCounter: document.getElementById('combo-counter'),
            comboNum: document.getElementById('combo-num'),
            tutorialModal: document.getElementById('tutorial-modal')
        };

        let audioCtx, analyser, mic;
        let isRunning = false;
        let loadTimeout;
        let comboCount = 0;
        let comboTimer = null;
        let lastScore = 0;

        // FIX: Bi·∫øn ƒë·ªÉ ki·ªÉm so√°t message thay ƒë·ªïi
        let currentMessage = "";
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 2000; // Message ƒë·ªïi sau 2 gi√¢y

        function closeTutorial() {
            UI.tutorialModal.style.display = 'none';
        }

        function getRandomMessage(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function optimizeForDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isSmallScreen = window.innerWidth < 640;

            if (isMobile || isSmallScreen) {
                return {
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 480 },
                        height: { ideal: 640 }
                    },
                    audio: true
                };
            }

            return {
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: true
            };
        }

        window.onload = async () => {
            if (window.location.protocol === 'file:') {
                showError("L·ªñI NGHI√äM TR·ªåNG: B·∫°n kh√¥ng ƒë∆∞·ª£c m·ªü tr·ª±c ti·∫øp file HTML.<br>H√£y upload l√™n web ho·∫∑c d√πng Live Server.");
                return;
            }

            loadTimeout = setTimeout(() => {
                if(UI.btnStart.classList.contains('hidden')) {
                    UI.errorArea.classList.remove('hidden');
                    UI.errorMsg.innerText = "M·∫°ng ch·∫≠m ho·∫∑c m√°y kh√¥ng h·ªó tr·ª£ AI.";
                    UI.statusText.innerText = "C√≥ s·ª± c·ªë...";
                    UI.spinner.style.display = 'none';
                }
            }, 8000);

            await loadAI();
        };

        async function loadAI() {
            const LOCAL = './models';
            const FALLBACK = 'https://justadudewhohacks.github.io/face-api.js/models';
            const attempts = [LOCAL, FALLBACK];

            for (const URL of attempts) {
                try {
                    UI.statusText.innerText = `ƒêang t·∫£i AI t·ª´: ${URL.includes('github') ? 'Cloud' : 'Local'}`;
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                        faceapi.nets.faceExpressionNet.loadFromUri(URL)
                    ]);

                    clearTimeout(loadTimeout);
                    UI.statusText.innerText = "S·∫µn s√†ng! üöÄ";
                    UI.spinner.style.display = 'none';
                    UI.overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
                    UI.btnStart.classList.remove('hidden');
                    return;
                } catch (err) {
                    console.warn('Failed loading from', URL);
                }
            }

            showError("Kh√¥ng t·∫£i ƒë∆∞·ª£c AI t·ª´ c·∫£ th∆∞ m·ª•c local v√† CDN.", new Error('Models fetch failed'));
            UI.errorMsg.innerHTML = `Kh√¥ng t·∫£i ƒë∆∞·ª£c model AI.<br><a href="https://github.com/justadudewhohacks/face-api.js-models" target="_blank" class="text-pink-300 underline">T·∫£i models t·∫°i ƒë√¢y</a>`;
            UI.errorArea.classList.remove('hidden');
        }

        async function initApp() {
            UI.btnStart.classList.add('hidden');
            UI.statusText.innerText = "ƒêang xin quy·ªÅn Camera & Mic...";
            UI.spinner.style.display = 'block';

            try {
                const constraints = optimizeForDevice();
                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                UI.video.srcObject = stream;
                setupAudio(stream);

                UI.video.onloadedmetadata = () => {
                    UI.video.play();
                    UI.overlay.style.display = 'none';
                    isRunning = true;
                    loop();
                };
            } catch (err) {
                showError("B·∫°n ƒë√£ ch·∫∑n Camera/Mic ho·∫∑c thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£.", err);
            }
        }

        function setupAudio(stream) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            mic = audioCtx.createMediaStreamSource(stream);
            mic.connect(analyser);
            analyser.fftSize = 256;
        }

        function getVolume() {
            if (!analyser) return 0;
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            return data.reduce((a, b) => a + b) / data.length;
        }

        function spawnFloatingEmoji(emoji) {
            const el = document.createElement('div');
            el.className = 'floating-emoji';
            el.innerText = emoji;
            el.style.left = (Math.random() * (window.innerWidth - 50)) + 'px';
            el.style.top = (window.innerHeight - 100) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function updateComboDisplay() {
            UI.comboNum.innerText = comboCount;
            if (comboCount > 0) {
                UI.comboCounter.classList.add('show');
            } else {
                UI.comboCounter.classList.remove('show');
            }
        }

        function triggerVibration() {
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]);
            }
        }

        async function loop() {
            if (!isRunning) return;

            const detection = await faceapi.detectSingleFace(UI.video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions();

            let smile = 0, mouthOpenRatio = 0, vol = getVolume();
            let isMouthOpen = false;

            if (detection) {
                smile = detection.expressions.happy;

                const mouth = detection.landmarks.getMouth();
                const innerLipHeight = Math.abs(mouth[14].y - mouth[18].y);
                const faceHeight = detection.detection.box.height;

                mouthOpenRatio = innerLipHeight / faceHeight;
                isMouthOpen = mouthOpenRatio > THRESHOLD.mouth;

                UI.txtSmile.innerText = (smile > THRESHOLD.smile ? "üòÜ " : "üòê ") + Math.round(smile*100) + "%";
                UI.txtSmile.className = smile > THRESHOLD.smile ? "text-green-400 font-bold sparkle" : "text-white";

                UI.txtMouth.innerText = isMouthOpen ? "üò¨ M·ªü" : "ü§ê ƒê√≥ng";
                UI.txtMouth.className = isMouthOpen ? "text-green-400 font-bold sparkle" : "text-white";
            }

            UI.txtVol.innerText = (vol > THRESHOLD.volume ? "üîä " : "üîá ") + Math.round(vol);
            UI.txtVol.className = vol > THRESHOLD.volume ? "text-green-400 font-bold sparkle" : "text-white";

            updateGame(smile, isMouthOpen, vol);

            requestAnimationFrame(loop);
        }

        function updateGame(smile, isMouthOpen, vol) {
            let score = 0;
            let msg = "";
            const now = Date.now();

            if (smile < THRESHOLD.smile) {
                score = Math.round(smile * 50);
                UI.progressBar.classList.remove('progress-glow');

                // Ch·ªâ ƒë·ªïi message sau MESSAGE_COOLDOWN
                if (!currentMessage || now - lastMessageTime > MESSAGE_COOLDOWN) {
                    msg = getRandomMessage(MESSAGES.needSmile);
                    currentMessage = msg;
                    lastMessageTime = now;
                } else {
                    msg = currentMessage;
                }

            } else if (!isMouthOpen) {
                score = 65;
                UI.progressBar.classList.add('progress-glow');

                if (!currentMessage || now - lastMessageTime > MESSAGE_COOLDOWN) {
                    msg = getRandomMessage(MESSAGES.needMouth);
                    currentMessage = msg;
                    lastMessageTime = now;
                } else {
                    msg = currentMessage;
                }

            } else if (vol < THRESHOLD.volume) {
                score = 85;
                UI.card.classList.remove("shake");
                UI.progressBar.classList.add('progress-glow');

                if (!currentMessage || now - lastMessageTime > MESSAGE_COOLDOWN) {
                    msg = getRandomMessage(MESSAGES.needVolume);
                    currentMessage = msg;
                    lastMessageTime = now;
                } else {
                    msg = currentMessage;
                }

            } else {
                msg = "XU·∫§T S·∫ÆC QU√Å ƒêI! üéâ‚ú®";
                score = 100;
                finish();
                return;
            }

            // Combo logic
            if (smile > THRESHOLD.smile && isMouthOpen && vol > THRESHOLD.volume * 0.7) {
                comboCount++;
                clearTimeout(comboTimer);
                updateComboDisplay();

                if (comboCount % 2 === 0) {
                    spawnFloatingEmoji(['üéâ', '‚≠ê', '‚ú®', 'üíñ', 'üéä', 'üåü'][Math.floor(Math.random() * 6)]);
                }

                if (comboCount % 5 === 0) {
                    confetti({
                        particleCount: 30,
                        spread: 60,
                        origin: { y: 0.7 }
                    });
                    triggerVibration();
                }

                comboTimer = setTimeout(() => {
                    comboCount = 0;
                    updateComboDisplay();
                }, 1500);
            }

            if (score > lastScore) {
                UI.progressBar.style.transition = 'width 0.3s ease-out';
            }
            lastScore = score;

            UI.gameMsg.innerText = msg;
            UI.progressBar.style.width = score + "%";
        }

        let finished = false;
        function finish() {
            if (finished) return;
            finished = true;
            isRunning = false;

            const duration = 3000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff0000', '#ffa500', '#ffff00', '#00ff00', '#0000ff', '#ff00ff']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff0000', '#ffa500', '#ffff00', '#00ff00', '#0000ff', '#ff00ff']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());

            UI.card.style.transform = 'scale(1.05)';
            UI.card.classList.add("shake");

            UI.gameMsg.innerText = "XU·∫§T S·∫ÆC QU√Å CH·ªä MIN ∆†I! QU√Ä T·∫∂NG ƒê√ÇY R·ªíI! üéÅ‚ú®üéä";
            UI.gameMsg.className = "text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-pink-500 animate-bounce";

            UI.progressBar.className = "h-full w-full rounded-full rainbow-bar";

            triggerVibration();

            setTimeout(() => {
                window.location.href = VOUCHER_LINK;
            }, 3000);
        }

        function showError(msg, err) {
            if (err) console.error(err);
            UI.overlay.style.display = 'flex';
            UI.spinner.style.display = 'none';
            UI.statusText.innerText = "ƒê√£ x·∫£y ra l·ªói üò¢";
            UI.errorArea.classList.remove('hidden');
            UI.errorMsg.innerHTML = msg;
        }
    </script>
</body>
</html>
