<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu√† t·∫∑ng ƒë·∫∑c bi·ªát d√†nh cho ch·ªã Th√∫y Min</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        video { transform: scaleX(-1); object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center">
        <h1 class="text-2xl font-bold text-orange-500 mb-4">CH·ªä TH√öY MIN H√ÉY C∆Ø·ªúI ƒê·ªÇ NH·∫¨N QU√Ä NH√ÅüéÅ</h1>
        
        <div id="container" class="relative rounded-2xl overflow-hidden bg-black aspect-square mb-4 shadow-inner">
            <video id="video" class="w-full h-full" autoplay muted playsinline webkit-playsinline></video>
            <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-80 text-white p-4">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-orange-500 mb-2"></div>
                <p id="loader-text" class="text-sm">Ch·ªã Min ch·ªù x√≠u nh√©...</p>
            </div>
        </div>

        <div id="status" class="text-lg font-bold text-gray-600 mb-2 italic">Ch·ªã Min ch·ªù x√≠u nh√©...</div>
        
        <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
            <div id="progress" class="bg-green-500 h-3 rounded-full transition-all duration-200" style="width: 0%"></div>
        </div>
        
        <button id="btn-retry" class="hidden px-4 py-2 bg-blue-500 text-white rounded-lg" onclick="location.reload()">Th·ª≠ l·∫°i</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress');
        const btnRetry = document.getElementById('btn-retry');

        const VOUCHER_LINK = "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWYxbWJnbzA4MG4xdzZ1aTl5ajkwZzRzcmE2a3cxamNxZWl2cXhxaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/gNke2UrUTopOg/giphy.gif"; // Thay link c·ªßa b·∫°n

        async function init() {
            try {
                // 1. T·∫£i Model
                const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                
                document.getElementById('loader-text').innerText = "Cho em quy·ªÅn camera n√†o...";

                // 2. M·ªü Camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 640 }
                    } 
                });
                
                video.srcObject = stream;
                
                // ƒê·∫£m b·∫£o video b·∫Øt ƒë·∫ßu ch·∫°y tr√™n mobile
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                    loader.style.display = 'none';
                    status.innerText = "C∆∞·ªùi l√™n ch·ªã Min ∆°iiiii!";
                    startDetection();
                });

            } catch (err) {
                console.error(err);
                loader.style.display = 'none';
                btnRetry.classList.remove('hidden');
                status.innerText = "L·ªói: " + (err.name === 'NotAllowedError' ? "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn Camera" : "Kh√¥ng t√¨m th·∫•y camera ho·∫∑c web kh√¥ng c√≥ HTTPS");
            }
        }

        function startDetection() {
            setInterval(async () => {
                const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();

                if (result) {
                    const happy = result.expressions.happy;
                    const score = Math.round(happy * 100);
                    
                    progress.style.width = score + "%";
                    
                    if (score > 80) {
                        status.innerText = "N·ª• c∆∞·ªùi tuy·ªát v·ªùi! Ch√∫c ch·ªã Min Gi√°ng Sinh vui v·∫ª üéâ";
                        status.style.color = "#10b981";
                        setTimeout(() => {
                            window.location.href = VOUCHER_LINK;
                        }, 800);
                    } else if (score > 20) {
                        status.innerText = "C∆∞·ªùi ch∆∞a ƒë·ªß ƒë√¥, nhe rƒÉng ra n√†o haha..";
                    }
                }
            }, 300);
        }

        window.onload = init;
    </script>
</body>
</html>

