<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile to Win | Nh·∫≠n Voucher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        #video-container video { transform: scaleX(-1); } /* Hi·ªáu ·ª©ng g∆∞∆°ng */
        .progress-bar { transition: width 0.2s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-yellow-100 to-orange-200 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-md text-center">
        <h1 class="text-3xl font-extrabold text-orange-600 mb-2">SMILE & WIN! üéÅ</h1>
        <p class="text-gray-500 mb-6">C∆∞·ªùi th·∫≠t t∆∞∆°i ƒë·ªÉ m·ªü kh√≥a Voucher n·ªôi b·ªô nh√©</p>

        <div id="video-container" class="relative rounded-2xl overflow-hidden bg-black aspect-video mb-6 border-4 border-orange-400 shadow-inner">
            <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
            <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white">
                <span class="animate-pulse">ƒêang t·∫£i AI...</span>
            </div>
        </div>

        <div class="mb-4">
            <div class="flex justify-between mb-1 text-sm font-medium text-orange-700">
                <span>ƒê·ªô t∆∞∆°i n·ª• c∆∞·ªùi</span>
                <span id="score-text">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress" class="bg-orange-500 h-4 rounded-full progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <p id="status-message" class="text-lg font-semibold text-gray-700 h-8">ƒêang kh·ªüi ƒë·ªông camera...</p>
    </div>

    <script>
        const video = document.getElementById('video');
        const progress = document.getElementById('progress');
        const scoreText = document.getElementById('score-text');
        const statusMessage = document.getElementById('status-message');
        const loadingOverlay = document.getElementById('loading-overlay');

        const VOUCHER_LINK = "https://your-voucher-link.com"; // THAY LINK C·ª¶A B·∫†N T·∫†I ƒê√ÇY

        // T·∫£i Model t·ª´ GitHub (ƒë√£ n√©n ƒë·ªÉ load nhanh)
        async function loadModels() {
            const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            startVideo();
        }

      async function startVideo() {
    const constraints = {
        video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: "user" // ∆Øu ti√™n camera tr∆∞·ªõc
        }
    };

    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // Quan tr·ªçng: ƒê·∫£m b·∫£o video th·ª±c s·ª± ph√°t
        video.onloadedmetadata = () => {
            video.play();
            loadingOverlay.classList.add('hidden');
            statusMessage.innerText = "S·∫µn s√†ng! C∆∞·ªùi l√™n n√†o üòä";
            detectSmile();
        };
    } catch (err) {
        console.error("L·ªói Camera: ", err);
        statusMessage.innerText = "Kh√¥ng th·ªÉ m·ªü camera. H√£y ki·ªÉm tra quy·ªÅn truy c·∫≠p ho·∫∑c d√πng HTTPS.";
        alert("L∆∞u √Ω: ·ª®ng d·ª•ng c·∫ßn HTTPS v√† quy·ªÅn truy c·∫≠p Camera ƒë·ªÉ ho·∫°t ƒë·ªông.");
    }
}

        async function detectSmile() {
            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();

                if (detections && detections.length > 0) {
                    const happyScore = detections[0].expressions.happy;
                    const percent = Math.round(happyScore * 100);

                    progress.style.width = percent + "%";
                    scoreText.innerText = percent + "%";

                    if (happyScore > 0.85) {
                        statusMessage.innerText = "TUY·ªÜT V·ªúI! ƒêang l·∫•y Voucher...";
                        statusMessage.classList.add('text-green-600');
                        setTimeout(() => {
                            window.location.href = VOUCHER_LINK;
                        }, 1500);
                    } else if (happyScore > 0.3) {
                        statusMessage.innerText = "T∆∞∆°i h∆°n ch√∫t n·ªØa n√†o!";
                    }
                }
            }, 300);
        }

        loadModels();
    </script>
</body>
</html>

