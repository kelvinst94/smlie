<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu√† t·∫∑ng ƒë·∫∑c bi·ªát üéÅ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* L·∫≠t ng∆∞·ª£c camera cho gi·ªëng g∆∞∆°ng */
        video { transform: scaleX(-1); object-fit: cover; }
        
        /* Hi·ªáu ·ª©ng rung khi c∆∞·ªùi to */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Thanh ti·∫øn ƒë·ªô 7 m√†u */
        .rainbow-bar {
            background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            background-size: 200% 200%;
            animation: rainbow 2s ease infinite;
        }
        @keyframes rainbow { 
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen flex flex-col items-center justify-center p-4 font-sans select-none">

    <div id="main-card" class="bg-white p-5 rounded-3xl shadow-2xl w-full max-w-sm text-center border-4 border-white relative">
        
        <div class="mb-4">
            <h1 class="text-2xl font-black text-pink-600 uppercase tracking-tighter">NHI·ªÜM V·ª§ NH·∫¨N QU√Ä</h1>
            <p class="text-sm text-gray-500">H√£y c∆∞·ªùi nhe rƒÉng & c∆∞·ªùi th√†nh ti·∫øng!</p>
        </div>

        <div class="relative rounded-2xl overflow-hidden bg-black aspect-[3/4] mb-4 shadow-inner ring-4 ring-pink-100">
            <video id="video" class="w-full h-full" autoplay muted playsinline webkit-playsinline></video>
            
            <div class="absolute top-2 left-2 right-2 flex justify-between text-[10px] font-mono text-white bg-black/50 p-2 rounded backdrop-blur-sm z-10">
                <div class="flex flex-col items-center">
                    <span id="txt-smile">üòê 0%</span>
                    <span class="text-gray-400">ƒê·ªò T∆Ø∆†I</span>
                </div>
                <div class="flex flex-col items-center border-x border-gray-600 px-2">
                    <span id="txt-mouth">ü§ê ƒê√≥ng</span>
                    <span class="text-gray-400">MI·ªÜNG</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="txt-vol">üîá 0</span>
                    <span class="text-gray-400">√ÇM L∆Ø·ª¢NG</span>
                </div>
            </div>

            <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-zinc-900 text-white z-20 transition-opacity duration-500">
                <div id="spinner" class="animate-spin rounded-full h-10 w-10 border-4 border-pink-500 border-t-transparent mb-4"></div>
                <p id="status-text" class="text-sm font-medium animate-pulse">ƒêang k·∫øt n·ªëi AI...</p>
                
                <div id="error-area" class="hidden flex flex-col items-center mt-4 w-3/4">
                    <p id="error-msg" class="text-xs text-red-400 text-center mb-3 border border-red-500/50 p-2 rounded bg-red-900/20">L·ªói kh√¥ng x√°c ƒë·ªãnh</p>
                    <button onclick="window.location.href = VOUCHER_LINK" class="bg-white text-black px-4 py-2 rounded-full text-xs font-bold hover:bg-gray-200">
                        üéÅ B·ªè qua & Nh·∫≠n qu√† lu√¥n
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-2 h-8 flex items-center justify-center">
            <span id="game-msg" class="text-lg font-bold text-gray-700">ƒêang chu·∫©n b·ªã...</span>
        </div>
        
        <div class="w-full bg-gray-100 rounded-full h-4 mb-5 overflow-hidden ring-1 ring-gray-200">
            <div id="progress-bar" class="bg-pink-500 h-full w-0 transition-all duration-300 ease-out"></div>
        </div>

        <button id="btn-start" class="hidden w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-bold shadow-lg shadow-pink-500/30 active:scale-95 transition-transform" onclick="initApp()">
            <i class="fas fa-camera mr-2"></i> B·∫ÆT ƒê·∫¶U CH∆†I
        </button>
    </div>

    <script>
        // ================= C·∫§U H√åNH =================
        const VOUCHER_LINK = "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWYxbWJnbzA4MG4xdzZ1aTl5ajkwZzRzcmE2a3cxamNxZWl2cXhxaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/gNke2UrUTopOg/giphy.gif"; 
        
        // ƒê·ªô kh√≥ (Ch·ªânh ·ªü ƒë√¢y)
        const THRESHOLD = {
            smile: 0.7,      // C·∫ßn c∆∞·ªùi 70%
            mouth: 0.15,     // ƒê·ªô m·ªü mi·ªáng (0.1 l√† v·ª´a, 0.2 l√† h√° to)
            volume: 20       // ƒê·ªô l·ªõn √¢m thanh
        };
        // ============================================

        const UI = {
            video: document.getElementById('video'),
            overlay: document.getElementById('overlay'),
            spinner: document.getElementById('spinner'),
            statusText: document.getElementById('status-text'),
            errorArea: document.getElementById('error-area'),
            errorMsg: document.getElementById('error-msg'),
            btnStart: document.getElementById('btn-start'),
            gameMsg: document.getElementById('game-msg'),
            progressBar: document.getElementById('progress-bar'),
            txtSmile: document.getElementById('txt-smile'),
            txtMouth: document.getElementById('txt-mouth'),
            txtVol: document.getElementById('txt-vol'),
            card: document.getElementById('main-card')
        };

        let audioCtx, analyser, mic;
        let isRunning = false;
        let loadTimeout;

        // 1. Ki·ªÉm tra m√¥i tr∆∞·ªùng ch·∫°y (Quan tr·ªçng!)
        window.onload = async () => {
            if (window.location.protocol === 'file:') {
                showError("L·ªñI NGHI√äM TR·ªåNG: B·∫°n kh√¥ng ƒë∆∞·ª£c m·ªü tr·ª±c ti·∫øp file HTML.<br>H√£y upload l√™n web ho·∫∑c d√πng Live Server.");
                return;
            }

            // H·∫πn gi·ªù: N·∫øu 8 gi√¢y m√† ch∆∞a t·∫£i xong AI th√¨ hi·ªán n√∫t B·ªè qua
            loadTimeout = setTimeout(() => {
                if(UI.btnStart.classList.contains('hidden')) {
                    UI.errorArea.classList.remove('hidden');
                    UI.errorMsg.innerText = "M·∫°ng ch·∫≠m ho·∫∑c m√°y kh√¥ng h·ªó tr·ª£ AI.";
                    UI.statusText.innerText = "C√≥ s·ª± c·ªë...";
                    UI.spinner.style.display = 'none';
                }
            }, 8000);

            await loadAI();
        };

        // 2. T·∫£i AI Models
        async function loadAI() {
            // Try local ./models first, then fallback to CDN
            const LOCAL = './models';
            const FALLBACK = 'https://justadudewhohacks.github.io/face-api.js/models';
            const attempts = [LOCAL, FALLBACK];

            for (const URL of attempts) {
                try {
                    UI.statusText.innerText = `ƒêang t·∫£i m√¥ h√¨nh t·ª´: ${URL}`;
                    console.log('Loading models from', URL);
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(URL), // C·∫ßn ƒë·ªÉ ƒëo mi·ªáng
                        faceapi.nets.faceExpressionNet.loadFromUri(URL)
                    ]);

                    clearTimeout(loadTimeout);
                    UI.statusText.innerText = "S·∫µn s√†ng!";
                    UI.spinner.style.display = 'none';
                    UI.overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
                    UI.btnStart.classList.remove('hidden');
                    console.log('Models loaded from', URL);
                    return;
                } catch (err) {
                    console.warn('Failed loading models from', URL, err && err.message);
                    // try next
                }
            }

            // If we reach here, all attempts failed
            showError("Kh√¥ng t·∫£i ƒë∆∞·ª£c AI t·ª´ c·∫£ th∆∞ m·ª•c local v√† CDN.", new Error('Models fetch failed'));
            // Provide quick instructions for the user
            UI.errorMsg.innerHTML = `Kh√¥ng t·∫£i model. H√£y t·∫£i th∆∞ m·ª•c <code>models/</code> v√†o c√πng th∆∞ m·ª•c v·ªõi file n√†y.<br>
            1) T·∫£i t·ª´: <a href="https://github.com/justadudewhohacks/face-api.js-models" target="_blank" class="text-pink-300 underline">face-api.js-models</a><br>
            2) Gi·∫£i n√©n th√†nh folder <code>models</code> v√† ph·ª•c v·ª• qua HTTP (kh√¥ng m·ªü b·∫±ng file://).`;
            UI.errorArea.classList.remove('hidden');
        }

        // 3. Kh·ªüi ƒë·ªông Camera & Mic
        async function initApp() {
            UI.btnStart.classList.add('hidden');
            UI.statusText.innerText = "ƒêang xin quy·ªÅn...";
            UI.spinner.style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: {ideal: 640}, height: {ideal: 480} }, 
                    audio: true 
                });

                UI.video.srcObject = stream;
                setupAudio(stream);

                UI.video.onloadedmetadata = () => {
                    UI.video.play();
                    UI.overlay.style.display = 'none'; // ·∫®n m√†n h√¨nh ch·ªù
                    isRunning = true;
                    loop();
                };
            } catch (err) {
                showError("B·∫°n ƒë√£ ch·∫∑n Camera/Mic ho·∫∑c thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£.", err);
            }
        }

        // 4. Thi·∫øt l·∫≠p √Çm thanh
        function setupAudio(stream) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            mic = audioCtx.createMediaStreamSource(stream);
            mic.connect(analyser);
            analyser.fftSize = 256;
        }

        function getVolume() {
            if (!analyser) return 0;
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            return data.reduce((a, b) => a + b) / data.length;
        }

        // 5. V√≤ng l·∫∑p x·ª≠ l√Ω ch√≠nh
        async function loop() {
            if (!isRunning) return;

            // Nh·∫≠n di·ªán khu√¥n m·∫∑t
            const detection = await faceapi.detectSingleFace(UI.video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions();

            let smile = 0, mouthOpenRatio = 0, vol = getVolume();
            let isMouthOpen = false;

            if (detection) {
                // a. C∆∞·ªùi
                smile = detection.expressions.happy;

                // b. M·ªü mi·ªáng (T√≠nh kho·∫£ng c√°ch m√¥i tr√™n - m√¥i d∆∞·ªõi)
                const mouth = detection.landmarks.getMouth();
                // ƒêi·ªÉm 14 (m√¥i tr√™n d∆∞·ªõi) v√† 18 (m√¥i d∆∞·ªõi tr√™n) c·ªßa inner lips
                const innerLipHeight = Math.abs(mouth[14].y - mouth[18].y);
                const faceHeight = detection.detection.box.height;
                
                mouthOpenRatio = innerLipHeight / faceHeight;
                isMouthOpen = mouthOpenRatio > THRESHOLD.mouth;

                // C·∫≠p nh·∫≠t Debug
                UI.txtSmile.innerText = isMouthOpen ? "üòÜ " + Math.round(smile*100) + "%" : "üòê " + Math.round(smile*100) + "%";
                UI.txtSmile.className = smile > THRESHOLD.smile ? "text-green-400 font-bold" : "text-white";
                
                UI.txtMouth.innerText = isMouthOpen ? "üò¨ M·ªü" : "ü§ê ƒê√≥ng";
                UI.txtMouth.className = isMouthOpen ? "text-green-400 font-bold" : "text-white";
            }

            UI.txtVol.innerText = vol > THRESHOLD.volume ? "üîä " + Math.round(vol) : "üîá " + Math.round(vol);
            UI.txtVol.className = vol > THRESHOLD.volume ? "text-green-400 font-bold" : "text-white";

            // --- LOGIC GAME ---
            updateGame(smile, isMouthOpen, vol);

            requestAnimationFrame(loop);
        }

        function updateGame(smile, isMouthOpen, vol) {
            let score = 0;
            let msg = "";

            if (smile < THRESHOLD.smile) {
                msg = "H√£y c∆∞·ªùi th·∫≠t t∆∞∆°i n√†o! üòÅ";
                score = smile * 40;
            } else if (!isMouthOpen) {
                msg = "C∆∞·ªùi nhe rƒÉng ra (M·ªü mi·ªáng)! üò¨";
                score = 65;
            } else if (vol < THRESHOLD.volume) {
                msg = "C∆∞·ªùi th√†nh ti·∫øng ƒëi: HA HA HA! üîä";
                score = 85;
                UI.card.classList.remove("shake");
            } else {
                // WIN
                msg = "TUY·ªÜT V·ªúI !!! üéâ";
                score = 100;
                finish();
                return;
            }

            UI.gameMsg.innerText = msg;
            UI.progressBar.style.width = score + "%";
        }

        let finished = false;
        function finish() {
            if (finished) return;
            finished = true;
            isRunning = false;
            
            UI.gameMsg.innerText = "CH√öC M·ª™NG GI√ÅNG SINH! üéÅ";
            UI.gameMsg.className = "text-xl font-bold text-pink-600 animate-bounce";
            
            UI.progressBar.className = "h-full w-full rounded-full rainbow-bar";
            UI.card.classList.add("shake");

            setTimeout(() => {
                window.location.href = VOUCHER_LINK;
            }, 1500);
        }

        function showError(msg, err) {
            console.error(err);
            UI.overlay.style.display = 'flex';
            UI.spinner.style.display = 'none';
            UI.statusText.innerText = "ƒê√£ x·∫£y ra l·ªói";
            UI.errorArea.classList.remove('hidden');
            UI.errorMsg.innerHTML = msg;
        }
    </script>
</body>
</html>
